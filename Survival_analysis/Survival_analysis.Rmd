---
Authors: ["**Yamuna Dhungana**"]
title: "Survival analysis"
date: 2021-10-11T17:26:23-05:00
draft: false
output: html_document
tags:
- R
- Statistics
summary: Statistics series
---

```{r global options, include = T}
knitr::opts_chunk$set(echo=T, warning=FALSE, message=FALSE)
```

We have data on survival of patients with lung cancer at Mayo Clinic. We want to answer the following questions and provide some graphs. We will use the \textbf{cancer} data located in the \textbf{survival} package to answer the following:


    a. What is the probability that someone will survive past 300 days?
    
    b. Provide a graph, including 95% confidence limits, of the Kaplan-Meier estimate of the entire study.
    
    c. Is there a difference in the survival rates between males and females? Provide a formal statistical test with a p-value and visual evidence.
    
    d. Is there a difference in the survival rates for the older half of the group versus the younger half? Provide a formal statistical test with a p-value and visual evidence.
    

```{r, echo=TRUE}
# load all required packages
library(survminer)
library(survival)
library(ggplot2)        
library(HSAUR3)
library(mclust)
library(knitr)
cat("1a.") 

data(cancer)

##status 1=censored, 2=dead
SA1=survfit(formula=Surv(time,status==2)~1, data=cancer)

print(summary(SA1,time=300))

cat("1b.")
plot(SA1,col="red",main="base R: Survival Chance based on Kaplan-Meir Estimate",
     xlab="Survival Time in Days",ylab="Probability of Survival")
abline(v=300,h=0.531,col="red")

p<- ggsurvplot(SA1, data = cancer) +
  labs (x = "Time (months)", title = "ggplot: Survival Chance based on Kaplan-Meir Estimate") 
p$plot + geom_hline(yintercept=0.531, color='red') + geom_vline(xintercept = 300, color='red')


cat("1c.")

cat("SEX values: male=1, female=2")
males.df=subset(cancer, sex==1)
females.df=subset(cancer, sex==2)

SUR_Male=survfit(formula=Surv(time,status==2)~1, data=males.df)
SUR_Female=survfit(formula=Surv(time,status==2)~1, data=females.df)

layout(matrix(1:1, ncol = 1))

plot(SUR_Male,col="black",main="Survival Chance by Gender",
     xlab="Survival Time (days)",ylab="Surviving Probability")
lines(SUR_Female,col="red")
legend("topright",c("Males","Females"),lty=c(1,1),
       lwd=c(2,2),col=c("black","red"))


plot(survfit(Surv(time,status==2)~sex, data=cancer),
     main="Males and Females Survival",lty=c(1,2),col=c("black","red"),
     ylab="Survival Probability",xlab="Survival Time (days)")
legend("topright",c("Males","Females"),lty=c(1,1),
       lwd=c(2,2),col=c("black","red"))

print(survdiff(formula=Surv(time,status==2)~sex,data=cancer))


cat("1d")
## Splitting data into young and old where age group=1 meansyoung half, age
## group=2 mean old half

dup.cancer <- cancer
dup.cancer$Age_Group <- 2
get.median <- median(cancer$age)

for(i in 1:nrow(cancer)){
  if(cancer[i,4] <= get.median){
    dup.cancer[i,11]=1}
}


young=subset(dup.cancer, Age_Group==1)
old=subset(dup.cancer, Age_Group==2)

young_sa=survfit(formula=Surv(time,status==2)~1, data=young)
old_sa=survfit(formula=Surv(time,status==2)~1, data=old)


plot(young_sa,col="black",main="Survival Probability Plot",
     xlab="Survival (days)",ylab="Surviving Probability")
lines(old_sa,col="red")
legend(800, 0.8, legend=c("Yound", "Old"),
       col=c("black", "red"), lty=c(1,1), cex=0.8)


plot(survfit(Surv(time,status==2)~Age_Group, data = dup.cancer),
     main="Survivability between young and old",lty=c(1,2),col=c("black","red"),
     ylab="Survival Probability",xlab="Survival (days)")
legend("topright",c("Young","Old"),lty=c(1,1),
       lwd=c(2,2),col=c("black","red"))

print(survdiff(formula=Surv(time,status==2)~Age_Group,data = dup.cancer))

```


Discussion:

1a. What is the probability that someone will survive past 300 days?

The survival probability after 300 days is 53.1% determined from the dataset.

1b. Provide a graph, including 95% confidence limits, of the Kaplan-Meier estimate of the entire study.

The plot based on the Kaplan-Meier estimator for the survival function shows that the survivability is in downward direction. The plot function generates the 95% confidence interval, and I have h and v lines drawn for survival probability at 300 days as well . The plot also indicates that within this timeline, the interval is higher for later days of survival time indicating larger variability in survival uncertainty (after 400 days of survivability).

1c. Is there a difference in the survival rates between males and females? Provide a formal statistical test with a p-value and visual evidence.

Yes, males and females have different surviving probabilities which can be determined based on Kaplan-Maier estimator on male and female groups. Second plot was also generated by using `plot(survfit(Surv(time,status==2)~sex, data=cancer)`. In this plot, the black line (males) lies below the red line (female) throughout the interval. This tells us that women have higher survival compared to males. The log rank test also indicates significant differece between sex groups with p-value of 0.001 to reject the NULL hypothesis (Null hypothesis: no difference in male and female survivability) with 95% confidence.

1d. Is there a difference in the survival rates for the older half of the group versus the younger half? Provide a formal statistical test with a p-value and visual evidence.

Here, data was divided into younger and older groups for the analysis based on median age. After properly splitting the data, a plot was generated based on Kaplan-Meir estimator for the two groups. Based on this plot, we can tell that the younger group (black line) of patients have longer survivability than the older patient groups(red line).However, based on the log rank test, the difference is not significant (P=0.17) to reject the NULL hypothesis ( NULL hypothesis: no difference in terms of survivability between the two age groups). 



2. A healthcare group has asked us to analyse the \textbf{mastectomy} data from the \textbf{HSAUR3} package, which is the survival times (in months) after a mastectomy of women with breast cancer. The cancers are classified as having metastasized or not based on a histochemical marker. The healthcare group requests that your report should not be longer than one page, and must only consist of one plot, one table, and one paragraph. So, we will do the following:

    a. Plot the survivor functions of each group only using GGPlot, estimated using the Kaplan-Meier estimate.

    b. Use a log-rank test to compare the survival experience of each group more formally. Only present a formal table of your results. 

    c. Write one paragraph summarizing your findings and conclusions. 

```{r,echo=FALSE}

## Q 2 a
data(mastectomy)
mt=mastectomy

fit <- survfit(Surv(time, event)~metastasized, data=mt)
summary(fit)

# > names(summary(fit))
#  [1] "n"             "time"          "n.risk"        "n.event"       "n.censor"     
#  [6] "surv"          "type"          "strata"        "std.err"       "lower"        
# [11] "upper"         "conf.type"     "conf.int"      "call"          "table"        
# [16] "rmean.endtime"

ggsurvplot(fit, data = mt) +
  labs (x = "Time (months)", title = "ggplot: Survival Chance of women with Breast Cancer")


## Q 2 b

lrt_fit=survdiff(formula=Surv(time,event==1)~metastasized,data=mt,rho=0)
# summary(lrt_fit)
ct_fit=coxph(formula=Surv(time,event)~metastasized,data=mt)
cat("log rank test")
print(lrt_fit)
cat("Cox's regression test")
print(ct_fit)
```

Question 2c: 

Explanation for part 2a

The figure in part 1, shows the survival probability of women with breast cancer under two categories- metastasized and not-metastasized. The red line shows the survival probability of those that have not undergone metastasis and the brown line shows the survival probability of those that have cancer metastasized elsewhere in the organs. Based on this plot we can tell that those with mestasized cancer have lower survival probability (brown line). After about 143 weeks, metastasized patient's (brown line) survival drops down to only 29.5 % whereas for non-metastasized (red line) pateint's the survival is still above 60%. 

Explanation for part 2b.

To determine whether the difference is statistically significant, I have performed log-rank test and got p-value of 0.061 which is not significant at P<0.05 whereas for Cox regression test, the p-value was even higher.

To summarize answer for part 2c:

Although we saw from the figure that the the survival probability of women with matastasized breast cancer is lower than those without metastasized breast cancer, the statistical test shows this difference to be statistically not siginificant. 

